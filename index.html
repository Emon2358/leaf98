<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>np2-wasm フロッピーセット対応</title>
    <script src="https://unpkg.com/np2-wasm/dist/elements.js" type="module"></script>
</head>
<body>
    <h1>PC-9801 エミュレータ (自由にフロッピーセット)</h1>
    
    <PC-9801 id="emulator" cpu-clock="12.5MHz" memory="2MB"></PC-9801>

    <br>
    <button onclick="selectDisk(0)">FDD1 にセット</button>
    <button onclick="selectDisk(1)">FDD2 にセット</button>
    <br>
    <button onclick="resetEmulator()">リセット</button>

    <input type="file" id="diskInput" accept=".d88" style="display: none" onchange="loadSelectedDisk(event)">

    <script type="module">
        import { NP2 } from "https://unpkg.com/np2-wasm/dist/np2-wasm.js";

        const emulatorElement = document.getElementById('emulator');
        const diskInput = document.getElementById('diskInput');
        let np2;
        let currentDrive = 0; // どのドライブにセットするか記憶

        async function initEmulator() {
            np2 = await NP2.create({ canvas: emulatorElement });
            np2.run();
        }

        function selectDisk(drive) {
            currentDrive = drive;
            diskInput.click(); // ファイル選択ダイアログを開く
        }

        async function loadSelectedDisk(event) {
            const file = event.target.files[0];
            if (!file || !np2) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = new Uint8Array(e.target.result);
                const fileName = file.name;
                np2.addDiskImage(fileName, data); // ディスクをエミュレータに追加
                np2.setFdd(currentDrive, fileName); // 選択したドライブにセット
            };
            reader.readAsArrayBuffer(file);
        }

        function resetEmulator() {
            if (np2) {
                np2.reset();
            }
        }

        initEmulator();
    </script>
</body>
</html>
