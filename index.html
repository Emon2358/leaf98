<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>NP2-wasm Drag & Drop</title>
    <script type="module" src="https://unpkg.com/np2-wasm/dist/elements.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        .emscripten_border {
            border: 2px dashed #999;
            padding: 20px;
            background-color: #fff;
            margin-bottom: 20px;
        }
        #droparea {
            width: 100%;
            height: 100px;
            line-height: 100px;
            font-size: 18px;
            cursor: pointer;
        }
        select {
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>NP2-wasm ドラッグ＆ドロップ</h1>
    <div class="emscripten_border" id="droparea">
        ここに.d88ファイルをドラッグ＆ドロップ
    </div>
    <PC-9801 id="np2" cpu-clock="12.5MHz" memory="2MB"></PC-9801>

    <div>
        <p><strong>FDDの設定</strong></p>
        <label>FDD1: <select id="fdd1"><option value="">(ejected)</option></select></label>
        <label>FDD2: <select id="fdd2"><option value="">(ejected)</option></select></label>
        <label>FDD3: <select id="fdd3"><option value="">(ejected)</option></select></label>
        <label>FDD4: <select id="fdd4"><option value="">(ejected)</option></select></label>
        <label>FDD5: <select id="fdd5"><option value="">(ejected)</option></select></label>
    </div>

    <script type="module">
        import { NP21 } from "https://unpkg.com/np2-wasm/dist/np2-wasm.js";

        const np2 = document.getElementById('np2');
        const droparea = document.getElementById('droparea');
        const fddSelects = [1, 2, 3, 4, 5].map(i => document.getElementById('fdd' + i));

        let np2Instance;

        async function initNP2() {
            if (!np2Instance) {
                np2Instance = await NP21.create({
                    canvas: np2,
                    clk_mult: 8,
                    Latencys: 120,
                    onDiskChange: (name) => console.log(name + ' changed'),
                    onExit: () => { np2Instance.reset(); }
                });
                console.log("NP2エミュレーター起動！");
            }
        }

        droparea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        droparea.addEventListener('drop', async (e) => {
            e.preventDefault();
            await initNP2();

            const files = Array.from(e.dataTransfer.files).slice(0, 5); // 最大5つのファイル
            if (files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const data = new Uint8Array(await file.arrayBuffer());

                console.log(`FDD${i + 1} に ${file.name} をセット`);
                np2Instance.setFdd(i, data); // np2wasm に直接セット

                // プルダウンメニューを更新
                let option = document.createElement('option');
                option.value = file.name;
                option.textContent = file.name;
                fddSelects[i].appendChild(option);
                fddSelects[i].value = file.name;
            }

            np2Instance.run(); // 実行！
        });

        // プルダウン変更時もリアルタイムでエミュレータに適用
        fddSelects.forEach((select, i) => {
            select.addEventListener('change', async () => {
                await initNP2();
                const selectedFile = select.value;
                if (selectedFile) {
                    console.log(`FDD${i + 1} を ${selectedFile} に変更`);
                    np2Instance.setFdd(i, selectedFile);
                } else {
                    np2Instance.setFdd(i, null);
                }
            });
        });
    </script>
</body>
</html>

