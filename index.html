<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>NP2-wasm Drag & Drop</title>
    <script type="module" src="https://unpkg.com/np2-wasm/dist/elements.js"></script>
    <style>
        .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
        div.emscripten { text-align: center; }
        div.emscripten_border { border: 1px solid black; padding: 10px; }
        canvas { border: 0px none; image-rendering: pixelated; }
        #droparea {
            width: 100%;
            height: 150px;
            border: 2px dashed #ccc;
            text-align: center;
            line-height: 150px;
            font-size: 18px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="emscripten_border" id="droparea">
        <p>ここにA〜Eの.d88ファイルをドラッグ＆ドロップ</p>
    </div>
    <PC-9801 id="np2" cpu-clock="12.5MHz" memory="2MB"></PC-9801>

    <div class="emscripten">
        <p>FDDの設定</p>
        <label>FDD1: <select id="fdd1"><option value="">(ejected)</option></select></label>
        <label>FDD2: <select id="fdd2"><option value="">(ejected)</option></select></label>
        <label>FDD3: <select id="fdd3"><option value="">(ejected)</option></select></label>
        <label>FDD4: <select id="fdd4"><option value="">(ejected)</option></select></label>
        <label>FDD5: <select id="fdd5"><option value="">(ejected)</option></select></label>
    </div>

    <script>
        const np2 = document.getElementById('np2');
        const droparea = document.getElementById('droparea');
        const fddSelects = [1, 2, 3, 4, 5].map(i => document.getElementById('fdd' + i));

        droparea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        droparea.addEventListener('drop', async (e) => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files).slice(0, 5); // 最大5つのファイルを取得

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = function(event) {
                    const data = new Uint8Array(event.target.result);
                    const fileName = file.name;

                    console.log(`FDD${i + 1} に ${fileName} をセット`);
                    np2.setAttribute(`fdd${i + 1}`, fileName);

                    // 選択リストに追加
                    let option = document.createElement('option');
                    option.value = fileName;
                    option.textContent = fileName;
                    fddSelects[i].appendChild(option);
                    fddSelects[i].value = fileName;
                };

                reader.readAsArrayBuffer(file);
            }
        });

        // ドライブの選択変更時
        fddSelects.forEach((select, i) => {
            select.addEventListener('change', () => {
                np2.setAttribute(`fdd${i + 1}`, select.value || '');
            });
        });
    </script>
</body>
</html>
