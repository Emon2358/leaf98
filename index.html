<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NP2-WASM Drag & Drop</title>
    <script src="np2wasm.js"></script> <!-- NP2-WASMのJSファイル -->
    <style>
        #dropzone {
            width: 100%;
            height: 200px;
            border: 2px dashed #ccc;
            text-align: center;
            line-height: 200px;
            font-size: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="dropzone">ここに .d88 ファイルをドラッグ＆ドロップ</div>
    <canvas id="emulatorCanvas"></canvas>

    <script>
        let np2 = null;
        let fddFiles = [];

        // NP2エミュレータを初期化
        async function initNP2() {
            np2 = await NP2.create({ canvas: document.getElementById("emulatorCanvas") });
            console.log("NP2エミュレータ起動");
        }

        // ドラッグ＆ドロップのイベントリスナー
        document.getElementById("dropzone").addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "copy";
        });

        document.getElementById("dropzone").addEventListener("drop", async (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            fddFiles = [];

            for (let i = 0; i < files.length && i < 5; i++) {  // 最大5つのドライブ
                const file = files[i];
                const reader = new FileReader();

                reader.onload = async function(event) {
                    const data = new Uint8Array(event.target.result);
                    const fileName = file.name;
                    
                    console.log(`ファイル読み込み: ${fileName}`);

                    fddFiles.push({ name: fileName, data });

                    if (np2) {
                        np2.addDiskImage(fileName, data);
                        np2.setFdd(i, fileName);
                        console.log(`FDD${i + 1} にセット: ${fileName}`);
                    }

                    if (i === files.length - 1) { // 最後のファイル処理後に実行
                        np2.run();
                        console.log("エミュレータ実行");
                    }
                };

                reader.readAsArrayBuffer(file);
            }
        });

        initNP2();
    </script>
</body>
</html>
